Suffix automata.
Uses http://e-maxx.ru/algo/suffix_automata code as base.